// Employee App (Python/Flask) - Jenkins CI/CD Pipeline
// QA Environment with Comprehensive Testing and Allure Reports

pipeline {
    agent any

    parameters {
        choice(
            name: 'BROWSER', 
            choices:['all', 'chrome', 'firefox', 'edge'], 
            description: 'Browser to run tests on'
        )
    }
    
    environment {
        // Application image name
        APP_NAME = 'expense-employee'
        APP_PORT = '5000'
        
        // AWS EC2 deployment target
        // EC2_HOST = credentials('ec2-deploy-host')
        // EC2_USER = 'ec2-user'
        
        // Build version
        BUILD_VERSION = "${BUILD_NUMBER}"
        
        // Docker-in-Docker: Host workspace path
        // When Jenkins runs in a container, Docker daemon needs the HOST path
        // Set JENKINS_HOME_HOST in Jenkins container env (e.g., /home/ec2-user/jenkins_home)
        WORKSPACE_HOST = "${env.JENKINS_HOME_HOST ?: env.JENKINS_HOME}/workspace/${env.JOB_NAME}"
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 45, unit: 'MINUTES')
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ Checking out source code...'
                checkout scm
                
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    echo "Building commit: ${env.GIT_COMMIT_SHORT}"
                }
            }
        }
        
        // ============================================
        // FAIL FAST: Run tests BEFORE building image
        // ============================================
        
        stage('Unit Tests') {
            agent {
                docker {
                    image 'python:3.12-slim'
                    args '-v ${WORKSPACE}/employee/allure-results:employee/allure-results'
                }
            }
            steps {
                echo 'ğŸ§ª Running Python Unit Tests with Allure...'
                sh '''
                    cd employee
                    mkdir -p test-results
                    
                    pip install --quiet -r requirements.txt
                    python -m pytest tests/unit_tests -v \
                        --alluredir=/allure-results \
                        --junitxml=test-results/unit-results.xml
                '''
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'employee/test-results/*.xml'
                }
            }
        }
        
        stage('API Tests') {
            agent {
                docker {
                    image 'python:3.12-slim'
                    args '-v ${WORKSPACE}/employee/allure-results:/employee/allure-results'
                }
            }
            steps {
                echo 'ğŸ”Œ Running Python API Tests...'
                sh '''
                    cd employee
                    mkdir -p test-results

                    pip install --quiet -r requirements.txt
                    python main.py &  # Start the app in the background
                    sleep 10 # Wait for app to be ready
                    python -m pytest tests/integration_tests -v \
                        --alluredir=/allure-results \
                        --junitxml=test-results/integration-results.xml
                '''
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'employee/test-results/*.xml'
                }
            }
        }
        
        stage('E2E Tests') {
            parallel {
                stage('Chrome E2E Tests') {
                    agent {
                        dockerfile {
                            filename 'Dockerfile.browsers'
                            dir 'employee'
                            args '-v /var/run/docker.sock:/var/run/docker.sock'
                        }
                    }
                    when {
                        expression {
                            // This stage only runs if the browser chosen is 'all' or 'chrome'
                            return params.BROWSER == 'all' || params.BROWSER == 'chrome'
                        }
                    }
                    steps {
                        echo 'ğŸŒ Running Python E2E Tests in Chrome (Behave + Selenium)...'
                        sh '''
                            cd employee
                            mkdir -p allure-results test-results
        
                            # Start the application in the background then wait for the app to be ready
                            pip install --quiet -r requirements.txt
                            python main.py &
                            sleep 10 
                            
                            # Run Behave tests
                            behave -D browser=chrome ./tests/system_tests/selenium/features || true
                        '''
                    }
                }
                stage('Firefox E2E Tests') {
                    agent {
                        dockerfile {
                            filename 'Dockerfile.browsers'
                            dir 'employee'
                            args '-v /var/run/docker.sock:/var/run/docker.sock'
                        }
                    }
                     when {
                        expression {
                            // This stage only runs if the browser chosen is 'all' or 'firefox'
                            return params.BROWSER == 'all' || params.BROWSER == 'firefox'
                        }
                    }
                    steps {
                        echo 'ğŸŒ Running Python E2E Tests in Firefox (Behave + Selenium)...'
                        sh '''
                            cd employee
                            mkdir -p allure-results test-results
        
                            # Start the application in the background then wait for the app to be ready
                            pip install --quiet -r requirements.txt
                            python main.py &
                            sleep 10 
                            
                            # Run Behave tests
                            behave -D browser=firefox ./tests/system_tests/selenium/features || true
                        '''
                    }
                }
                stage('Edge E2E Tests') {
                    agent {
                        dockerfile {
                            filename 'Dockerfile.browsers'
                            dir 'employee'
                            args '-v /var/run/docker.sock:/var/run/docker.sock'
                        }
                    }
                     when {
                        expression {
                            // This stage only runs if the browser chosen is 'all' or 'edge'
                            return params.BROWSER == 'all' || params.BROWSER == 'edge'
                        }
                    }
                    steps {
                        echo 'ğŸŒ Running Python E2E Tests in Edge (Behave + Selenium)...'
                        sh '''
                            cd employee
                            mkdir -p allure-results test-results
        
                            # Start the application in the background then wait for the app to be ready
                            pip install --quiet -r requirements.txt
                            python main.py &
                            sleep 10 
                            
                            # Run Behave tests
                            behave -D browser=edge ./tests/system_tests/selenium/features || true
                        '''
                    }
                }
            }
        }
        
        stage('Code Coverage') {
            agent {
                docker {
                    image 'python:3.12-slim'
                }
            }
            steps {
                echo 'ğŸ“ˆ Generating Code Coverage Report...'
                sh '''
                    cd employee
                    pip install -r requirements.txt 
                    pip install coverage 
                    pip install pytest-cov 
                    coverage run -m pytest tests/unit_tests 
                    coverage xml -o coverage.xml
                    coverage html -d htmlcov
                '''
            }
            post {
                always {
                    publishHTML(target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'employee/htmlcov',
                        reportFiles: 'index.html',
                        reportName: 'Python Coverage Report'
                    ])
                }
            }
        }

        // ============================================
        // BUILD: Only after tests pass
        // ============================================
        stage('Deploy to QA Environment') {
            steps {
                echo 'ğŸ Building Python Employee Application...'
                sh '''
                    docker stop ${APP_NAME} || true
                    docker rm ${APP_NAME} || true
                    docker rmi ${APP_NAME} || true
                    docker-compose up -d --build employee-app
                '''
            }
        }
    }
    
    post {
        always {
            echo 'ğŸ“Š Generating Allure Report...'
            allure([
                        includeProperties: false,
                        results: [[path: 'employee/allure-results']]
                    ])

            echo 'ğŸ§¹ Cleaning up...'
            sh '''
                docker stop ${APP_NAME}-test || true
                docker rm ${APP_NAME}-test || true
                docker rmi ${APP_NAME}:${BUILD_VERSION} || true
            '''
            
            archiveArtifacts artifacts: '''
                employee/test-results/**/*.xml,
                employee/allure-results/**/*,
                employee/htmlcov/**/*
            ''', allowEmptyArchive: true
        }
        
        success {
            echo '''
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘  âœ… EMPLOYEE APP PIPELINE COMPLETED SUCCESSFULLY             â•‘
            â•‘                                                              â•‘
            â•‘  ğŸ“Š Reports: Click "Allure Report" in sidebar                â•‘
            â•‘  ğŸ“ˆ Coverage: Click "Python Coverage Report"                 â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            '''
        }
        
        failure {
            echo 'âŒ Pipeline failed! Check console output for details.'
        }
    }
}
