pipeline {
  agent any

  environment {
    APP_NAME      = 'expense-manager'
    APP_PORT      = '5001'
    BUILD_VERSION = "${BUILD_NUMBER}"
    APP_URL       = "http://localhost:${APP_PORT}"

    TEST_NETWORK  = "jenkins-test-network"

    CONTAINER_WS  = "/home/appuser/workspace"
    CONTAINER_UID = "1001"
    CONTAINER_GID = "1001"

    SEED_DB_PATH  = "manager/seed/expense_manager.db"
    DB_VOLUME     = "expense-data"

    // ‚úÖ Selenium Grid (Hub + Nodes) settings
    SELENIUM_HUB           = "selenium-hub"
    SELENIUM_HUB_IMAGE     = "selenium/hub:4.25.0"
    SEL_NODE_CHROME        = "selenium-node-chrome"
    SEL_NODE_FIREFOX       = "selenium-node-firefox"
    SEL_NODE_EDGE          = "selenium-node-edge"
    SEL_NODE_CHROME_IMAGE  = "selenium/node-chrome:4.25.0"
    SEL_NODE_FIREFOX_IMAGE = "selenium/node-firefox:4.25.0"
    SEL_NODE_EDGE_IMAGE    = "selenium/node-edge:4.25.0"
    SELENIUM_REMOTE_URL    = "http://selenium-hub:4444/wd/hub"
  }

  options {
    buildDiscarder(logRotator(numToKeepStr: '10'))
    timestamps()
    timeout(time: 45, unit: 'MINUTES')
  }

  parameters {
    booleanParam(name: 'SKIP_UNIT_TESTS', defaultValue: false, description: 'Skip Unit Tests stage')
    booleanParam(name: 'SKIP_API_TESTS', defaultValue: false, description: 'Skip API Tests stage')
    booleanParam(name: 'SKIP_E2E_TESTS', defaultValue: false, description: 'Skip E2E Tests stage')
    booleanParam(name: 'SKIP_PERFORMANCE_TESTS', defaultValue: false, description: 'Skip Performance Tests stage')
    booleanParam(name: 'SKIP_CODE_COVERAGE', defaultValue: false, description: 'Skip Code Coverage stage')
    booleanParam(name: 'SKIP_ALLURE', defaultValue: false, description: 'Skip Allure Report stage')
    booleanParam(name: 'SKIP_DEPLOY', defaultValue: false, description: 'Skip Deploy to QA stage')
  }

  stages {

    stage('Checkout') {
      steps {
        echo 'üì• Checking out source code...'
        checkout scm
        script {
          env.GIT_COMMIT_SHORT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
          echo "Building commit: ${env.GIT_COMMIT_SHORT}"
        }

        sh '''
          echo "---- Workspace ----"
          pwd
          ls -la

          echo "---- manager/seed ----"
          ls -la manager/seed || true

          echo "---- Expecting seed DB at: ${SEED_DB_PATH} ----"
          if [ -f "${SEED_DB_PATH}" ]; then
            echo "‚úÖ Seed DB found"
          else
            echo "‚ùå Seed DB NOT found at ${SEED_DB_PATH}"
            exit 1
          fi
        '''
      }
    }

    stage('Build Docker Images') {
      steps {
        echo '‚òï Building Java Manager Docker images...'
        dir('manager') {
          sh '''
            set -e

            docker build \
              -t ${APP_NAME}:${BUILD_VERSION} \
              -t ${APP_NAME}:latest \
              -f Dockerfile .

            docker build \
              --target testrunner \
              -t ${APP_NAME}-testrunner:${BUILD_VERSION} \
              -f Dockerfile .
          '''
        }
      }
    }

    // ‚úÖ ADDED: Unit tests stage (matches your folder: com.revature.unittests)
    stage('Unit Tests') {
      when { expression { !params.SKIP_UNIT_TESTS } }
      steps {
        echo "üß™ Running Java Unit Tests (com.revature.unittests...)"
        sh '''
          set -e

          docker run --rm \
            -v "$PWD":"${CONTAINER_WS}" \
            -w "${CONTAINER_WS}/manager" \
            ${APP_NAME}-testrunner:${BUILD_VERSION} \
            sh -lc '
              set -e
              mvn -v
              mvn -B clean test \
                -Dtest="com.revature.unittests.**" \
                -Dmaven.test.failure.ignore=true
            '
        '''
      }
      post {
        always {
          junit allowEmptyResults: true, testResults: 'manager/target/surefire-reports/*.xml'
        }
      }
    }

    // ‚úÖ CHANGED: start app if either API or E2E tests are enabled
    stage('Start Application') {
      when { expression { !params.SKIP_API_TESTS || !params.SKIP_E2E_TESTS } }
      steps {
        echo 'üöÄ Starting Manager App (testrunner image) for Testing...'
        sh '''
          set -e

          docker network create ${TEST_NETWORK} >/dev/null 2>&1 || true

          docker stop ${APP_NAME}-test >/dev/null 2>&1 || true
          docker rm ${APP_NAME}-test >/dev/null 2>&1 || true

          docker volume rm ${DB_VOLUME} >/dev/null 2>&1 || true
          docker volume create ${DB_VOLUME} >/dev/null

          echo "üå± Seeding DB volume with ${SEED_DB_PATH} ..."
          test -f "${SEED_DB_PATH}"

          docker rm -f seed-helper >/dev/null 2>&1 || true
          docker create --name seed-helper -v ${DB_VOLUME}:/data alpine:3.20 >/dev/null
          docker cp "${SEED_DB_PATH}" seed-helper:/data/expense_manager.db
          docker rm -f seed-helper >/dev/null

          # ‚úÖ FIX: make /data directory writable (SQLite journaling needs this)
          docker run --rm -v ${DB_VOLUME}:/data alpine:3.20 sh -lc \
            "chown -R ${CONTAINER_UID}:${CONTAINER_GID} /data && chmod 775 /data && chmod 664 /data/expense_manager.db"

          docker run -d \
            --name ${APP_NAME}-test \
            --network ${TEST_NETWORK} \
            -p ${APP_PORT}:${APP_PORT} \
            -v ${DB_VOLUME}:/data \
            ${APP_NAME}-testrunner:${BUILD_VERSION}

          echo "Waiting for application health (inside container)..."
          for i in $(seq 1 30); do
            if docker exec ${APP_NAME}-test sh -lc "wget -q --spider http://localhost:${APP_PORT}/health"; then
              echo "‚úÖ Application is healthy!"
              sleep 2
              exit 0
            fi
            echo "‚è≥ Not ready yet (${i}/30)..."
            sleep 2
          done

          echo "‚ùå App did not become healthy in time"
          docker logs ${APP_NAME}-test || true
          exit 1
        '''
      }
    }

    // ‚úÖ CHANGED: sync repo if either API or E2E tests are enabled
    stage('Sync Repo Into App Container') {
      when { expression { !params.SKIP_API_TESTS || !params.SKIP_E2E_TESTS } }
      steps {
        echo 'üì¶ Syncing repository into running app container...'
        sh '''
          set -e

          docker exec -u 0 ${APP_NAME}-test sh -lc "
            rm -rf ${CONTAINER_WS} /tmp/repo &&
            mkdir -p ${CONTAINER_WS} /tmp/repo
          "

          docker cp . ${APP_NAME}-test:/tmp/repo

          docker exec -u 0 ${APP_NAME}-test sh -lc "
            rm -rf ${CONTAINER_WS}/* &&
            cp -R /tmp/repo/. ${CONTAINER_WS}/ &&
            chown -R ${CONTAINER_UID}:${CONTAINER_GID} ${CONTAINER_WS} &&
            rm -rf /tmp/repo
          "

          docker exec ${APP_NAME}-test sh -lc "test -f ${CONTAINER_WS}/manager/pom.xml && echo '‚úÖ pom.xml present' || (echo '‚ùå pom.xml missing' && exit 1)"
        '''
      }
    }

    stage('API Tests') {
      when { expression { !params.SKIP_API_TESTS } }
      steps {
        echo "üîå Running Java API Tests INSIDE ${APP_NAME}-test (same container)..."
        sh '''
          set -e

          docker exec ${APP_NAME}-test sh -lc "command -v mvn && mvn -v && java -version"

          docker exec ${APP_NAME}-test sh -lc "ls -la /data || true"
          docker exec ${APP_NAME}-test sh -lc "test -f /data/expense_manager.db && echo '‚úÖ DB present in /data' || (echo '‚ùå DB missing in /data' && exit 1)"

          docker exec ${APP_NAME}-test sh -lc '
            set -e
            cd '"${CONTAINER_WS}"'/manager
            rm -rf target || true

            # ‚úÖ FIX: Ensure tests write to SAME DB path + writable directory
            export DATABASE_PATH=/data/expense_manager.db
            export DB_PATH=/data/expense_manager.db

            mvn -B clean test \
              -Dtest="**/integrationtests/**" \
              -Dapp.url=http://localhost:'"${APP_PORT}"' \
              -DbaseUrl=http://localhost:'"${APP_PORT}"' \
              -Dmaven.test.failure.ignore=true
          '
        '''
      }
      post {
        always {
          junit allowEmptyResults: true, testResults: '**/target/surefire-reports/*.xml'
        }
      }
    }

    // ‚úÖ FIXED: Selenium vars are defined + safe quoting + debug + fail-fast
    stage('Start Selenium Grid') {
      when { expression { !params.SKIP_E2E_TESTS } }
      steps {
        sh '''
          set -e

          echo "SELENIUM_HUB=${SELENIUM_HUB}"
          echo "SELENIUM_HUB_IMAGE=${SELENIUM_HUB_IMAGE}"
          echo "TEST_NETWORK=${TEST_NETWORK}"

          test -n "${SELENIUM_HUB}" || (echo "‚ùå SELENIUM_HUB is empty" && exit 1)
          test -n "${SELENIUM_HUB_IMAGE}" || (echo "‚ùå SELENIUM_HUB_IMAGE is empty" && exit 1)

          docker rm -f "${SELENIUM_HUB}" "${SEL_NODE_CHROME}" "${SEL_NODE_FIREFOX}" "${SEL_NODE_EDGE}" >/dev/null 2>&1 || true

          docker run -d \
            --name "${SELENIUM_HUB}" \
            --network "${TEST_NETWORK}" \
            -p 4444:4444 \
            "${SELENIUM_HUB_IMAGE}"

          docker run -d \
            --name "${SEL_NODE_CHROME}" \
            --network "${TEST_NETWORK}" \
            -e SE_EVENT_BUS_HOST="${SELENIUM_HUB}" \
            -e SE_EVENT_BUS_PUBLISH_PORT=4442 \
            -e SE_EVENT_BUS_SUBSCRIBE_PORT=4443 \
            "${SEL_NODE_CHROME_IMAGE}"

          docker run -d \
            --name "${SEL_NODE_FIREFOX}" \
            --network "${TEST_NETWORK}" \
            -e SE_EVENT_BUS_HOST="${SELENIUM_HUB}" \
            -e SE_EVENT_BUS_PUBLISH_PORT=4442 \
            -e SE_EVENT_BUS_SUBSCRIBE_PORT=4443 \
            "${SEL_NODE_FIREFOX_IMAGE}"

          docker run -d \
            --name "${SEL_NODE_EDGE}" \
            --network "${TEST_NETWORK}" \
            -e SE_EVENT_BUS_HOST="${SELENIUM_HUB}" \
            -e SE_EVENT_BUS_PUBLISH_PORT=4442 \
            -e SE_EVENT_BUS_SUBSCRIBE_PORT=4443 \
            "${SEL_NODE_EDGE_IMAGE}"

          echo "Waiting for Selenium hub..."
          for i in $(seq 1 30); do
            if docker exec "${SELENIUM_HUB}" sh -lc "wget -qO- http://localhost:4444/status | grep -q '\\"ready\\":true'"; then
              echo "‚úÖ Selenium Grid ready"
              exit 0
            fi
            echo "‚è≥ Grid not ready yet (${i}/30)..."
            sleep 2
          done

          docker logs "${SELENIUM_HUB}" || true
          exit 1
        '''
      }
    }

    // ‚úÖ Uses your runner class: com.revature.systemtests.selenium.runners.TestRunner
    stage('E2E Tests (Selenium)') {
      when { expression { !params.SKIP_E2E_TESTS } }
      parallel {
        stage('E2E - Chrome') {
          steps {
            sh '''
              set -e
              docker exec ${APP_NAME}-test sh -lc '
                set -e
                cd '"${CONTAINER_WS}"'/manager
                rm -rf target || true

                export BASE_URL="http://localhost:'"${APP_PORT}"'"

                mvn -B clean test \
                  -Dtest="com.revature.systemtests.selenium.runners.TestRunner" \
                  -DbaseUrl="${BASE_URL}" \
                  -Dselenium.remoteUrl="'${SELENIUM_REMOTE_URL}'" \
                  -Dbrowser=chrome \
                  -Dmaven.test.failure.ignore=true
              '
            '''
          }
          post { always { junit allowEmptyResults: true, testResults: 'manager/target/surefire-reports/*.xml' } }
        }

        stage('E2E - Firefox') {
          steps {
            sh '''
              set -e
              docker exec ${APP_NAME}-test sh -lc '
                set -e
                cd '"${CONTAINER_WS}"'/manager
                rm -rf target || true

                export BASE_URL="http://localhost:'"${APP_PORT}"'"

                mvn -B clean test \
                  -Dtest="com.revature.systemtests.selenium.runners.TestRunner" \
                  -DbaseUrl="${BASE_URL}" \
                  -Dselenium.remoteUrl="'${SELENIUM_REMOTE_URL}'" \
                  -Dbrowser=firefox \
                  -Dmaven.test.failure.ignore=true
              '
            '''
          }
          post { always { junit allowEmptyResults: true, testResults: 'manager/target/surefire-reports/*.xml' } }
        }

        stage('E2E - Edge') {
          steps {
            sh '''
              set -e
              docker exec ${APP_NAME}-test sh -lc '
                set -e
                cd '"${CONTAINER_WS}"'/manager
                rm -rf target || true

                export BASE_URL="http://localhost:'"${APP_PORT}"'"

                mvn -B clean test \
                  -Dtest="com.revature.systemtests.selenium.runners.TestRunner" \
                  -DbaseUrl="${BASE_URL}" \
                  -Dselenium.remoteUrl="'${SELENIUM_REMOTE_URL}'" \
                  -Dbrowser=edge \
                  -Dmaven.test.failure.ignore=true
              '
            '''
          }
          post { always { junit allowEmptyResults: true, testResults: 'manager/target/surefire-reports/*.xml' } }
        }
      }
    }

    stage('Stop Selenium Grid') {
      when { expression { !params.SKIP_E2E_TESTS } }
      steps {
        sh '''
          docker rm -f "${SELENIUM_HUB}" "${SEL_NODE_CHROME}" "${SEL_NODE_FIREFOX}" "${SEL_NODE_EDGE}" >/dev/null 2>&1 || true
        '''
      }
    }

    stage('Stop Test Container') {
      steps {
        echo 'üõë Stopping test container...'
        sh '''
          docker stop ${APP_NAME}-test || true
          docker rm ${APP_NAME}-test || true
        '''
      }
    }

    stage('Generate Allure Report') {
      when { expression { !params.SKIP_ALLURE } }
      steps {
        echo 'üìä Generating Allure Report...'
      }
      post {
        always {
          allure([
            includeProperties: false,
            results: [[path: 'manager/target/allure-results']]
          ])
        }
      }
    }

    stage('Deploy to QA') {
      when {
        allOf {
          expression { !params.SKIP_DEPLOY }
          branch 'main'
          expression { currentBuild.currentResult == 'SUCCESS' }
        }
      }
      steps {
        echo 'üöÄ All tests passed! Deploying Manager App to QA...'
      }
    }
  }

  post {
    always {
      echo 'üßπ Cleaning up...'
      sh '''
        docker stop ${APP_NAME}-test || true
        docker rm ${APP_NAME}-test || true

        docker rm -f "${SELENIUM_HUB}" "${SEL_NODE_CHROME}" "${SEL_NODE_FIREFOX}" "${SEL_NODE_EDGE}" >/dev/null 2>&1 || true

        docker rmi ${APP_NAME}:${BUILD_VERSION} || true
        docker rmi ${APP_NAME}-testrunner:${BUILD_VERSION} || true
      '''
    }
    failure {
      echo '‚ùå Pipeline failed! Check console output for details.'
    }
  }
}
