// Employee App (Python/Flask) - Jenkins CI/CD Pipeline
// QA Environment with Comprehensive Testing and Allure Reports

pipeline {
    agent any

    parameters {
        choice(name: 'BROWSER', choices:['chrome', 'firefox', 'edge'], description: 'Web Browser')
    }
    
    environment {
        // Application image name
        APP_NAME = 'expense-employee'
        APP_PORT = '5000'
        
        // AWS EC2 deployment target
        // EC2_HOST = credentials('ec2-deploy-host')
        // EC2_USER = 'ec2-user'
        
        // Build version
        BUILD_VERSION = "${BUILD_NUMBER}"
        
        // Docker-in-Docker: Host workspace path
        // When Jenkins runs in a container, Docker daemon needs the HOST path
        // Set JENKINS_HOME_HOST in Jenkins container env (e.g., /home/ec2-user/jenkins_home)
        WORKSPACE_HOST = "${env.JENKINS_HOME_HOST ?: env.JENKINS_HOME}/workspace/${env.JOB_NAME}"
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 45, unit: 'MINUTES')
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ Checking out source code...'
                checkout scm
                
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    echo "Building commit: ${env.GIT_COMMIT_SHORT}"
                }
            }
        }
        
        // ============================================
        // FAIL FAST: Run tests BEFORE building image
        // ============================================
        
        stage('Unit Tests') {
            agent {
                docker {
                    image 'python:3.12-slim'
                }
            }
            steps {
                echo 'ğŸ§ª Running Python Unit Tests with Allure...'
                sh '''
                    cd employee
                    mkdir -p allure-results test-results
                    
                    pip install --quiet -r requirements.txt
                    python -m pytest tests/unit_tests -v \
                        --alluredir=allure-results \
                        --junitxml=test-results/unit-results.xml
                '''
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'test-results/*.xml'
                }
            }
        }
        
        stage('API Tests') {
            agent {
                docker {
                    image 'python:3.12-slim'
                }
            }
            steps {
                echo 'ğŸ”Œ Running Python API Tests...'
                sh '''
                    cd employee
                    mkdir -p allure-results test-results

                    pip install --quiet -r requirements.txt
                    python main.py &  # Start the app in the background
                    sleep 10 # Wait for app to be ready
                    python -m pytest tests/integration_tests -v \
                        --alluredir=/app/allure-results \
                        --junitxml=/app/test-results/integration-results.xml
                '''
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'test-results/integration-results.xml'
                }
            }
        }
        
       /* stage('E2E Tests') {
            agent {
                docker {
                    image 'python:3.12-slim'
                }
            }
            steps {
                echo 'ğŸŒ Running Python E2E Tests (Behave + Integration)...'
                sh '''
                    cd employee
                    mkdir -p allure-results test-results

                    # Start the application
                    pip install --quiet -r requirements.txt
                    # TODO: pip install browsers
                    
                    # Run Behave tests
                    behave -D browser=${params.BROWSER} ./tests/system_tests/selenium/features
                '''
            }
        } */
        
        stage('Code Coverage') {
            agent {
                docker {
                    image 'python:3.12-slim'
                }
            }
            steps {
                echo 'ğŸ“ˆ Generating Code Coverage Report...'
                sh '''
                    cd employee
                    pip install -r requirements.txt 
                    pip install coverage 
                    pip install pytest-cov 
                    coverage run -m pytest tests/unit_tests 
                    coverage xml -o coverage.xml
                    coverage html -d htmlcov
                '''
            }
            post {
                always {
                    publishHTML(target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'htmlcov',
                        reportFiles: 'index.html',
                        reportName: 'Python Coverage Report'
                    ])
                }
            }
        }
        
        stage('Generate Allure Report') {
            steps {
                echo 'ğŸ“Š Generating Allure Report...'
            }
            post {
                always {
                    allure([
                        includeProperties: false,
                        results: [[path: 'allure-results']]
                    ])
                }
            }
        }

        // ============================================
        // BUILD: Only after tests pass
        // ============================================
        stage('Deploy to QA Environment') {
            steps {
                echo 'ğŸ Building Python Employee Application...'
                sh '''
                    docker-compose down
                    docker-compose up -d --build employee-app
                '''
            }
        }
    }
    
    post {
        always {
            echo 'ğŸ§¹ Cleaning up...'
            sh '''
                docker stop ${APP_NAME}-test || true
                docker rm ${APP_NAME}-test || true
                docker rmi ${APP_NAME}:${BUILD_VERSION} || true
            '''
            
            archiveArtifacts artifacts: '''
                test-results/**/*.xml,
                allure-results/**/*,
                htmlcov/**/*
            ''', allowEmptyArchive: true
        }
        
        success {
            echo '''
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘  âœ… EMPLOYEE APP PIPELINE COMPLETED SUCCESSFULLY             â•‘
            â•‘                                                              â•‘
            â•‘  ğŸ“Š Reports: Click "Allure Report" in sidebar                â•‘
            â•‘  ğŸ“ˆ Coverage: Click "Python Coverage Report"                 â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            '''
        }
        
        failure {
            echo 'âŒ Pipeline failed! Check console output for details.'
        }
    }
}
