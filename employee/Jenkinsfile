pipeline {
    agent any

    environment {
        APP_NAME = 'expense-employee'
        APP_PORT = '5000'
        BUILD_VERSION = "${BUILD_NUMBER}"

        // If Jenkins home is bind-mounted on host, set this in container env
        WORKSPACE_HOST = "${env.JENKINS_HOME_HOST ?: env.JENKINS_HOME}/workspace/${env.JOB_NAME}"
    }

    options {
        timestamps()
        timeout(time: 45, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
                sh 'git rev-parse --short HEAD'
            }
        }

        stage('Unit Tests') {
            steps {
                sh '''
                mkdir -p allure-results test-results

                docker run --rm \
                  -v ${WORKSPACE_HOST}:/app \
                  -w /app/employee \
                  python:3.12-slim \
                  sh -lc "pip install -r requirements.txt && \
                          pytest tests/unit -v \
                          --alluredir=/app/allure-results \
                          --junitxml=/app/test-results/unit-results.xml"
                '''
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'test-results/*.xml'
                }
            }
        }

        stage('Integration Tests') {
            steps {
                sh '''
                mkdir -p allure-results test-results

                docker run --rm \
                  -v ${WORKSPACE_HOST}:/app \
                  -w /app/employee \
                  python:3.12-slim \
                  sh -lc "pip install -r requirements.txt && \
                          pytest tests/integration -v -m integration \
                          --alluredir=/app/allure-results \
                          --junitxml=/app/test-results/integration-results.xml"
                '''
            }
        }

        stage('Build Docker Image') {
            steps {
                sh '''
                docker build \
                  -t ${APP_NAME}:${BUILD_VERSION} \
                  -t ${APP_NAME}:latest \
                  -f employee/Dockerfile employee
                '''
            }
        }

        stage('Start Application') {
            steps {
                sh '''
                docker stop ${APP_NAME}-test || true
                docker rm ${APP_NAME}-test || true

                docker run -d \
                  --name ${APP_NAME}-test \
                  -p ${APP_PORT}:${APP_PORT} \
                  -v expense-data:/data \
                  ${APP_NAME}:${BUILD_VERSION}

                sleep 15
                curl -f http://localhost:${APP_PORT}/health
                '''
            }
        }

        stage('API Tests') {
            steps {
                sh '''
                mkdir -p allure-results test-results

                docker run --rm \
                  --network host \
                  -v ${WORKSPACE_HOST}:/app \
                  -w /app/employee \
                  -e API_BASE_URL=http://localhost:${APP_PORT} \
                  -e DATABASE_PATH=/app/employee/tests/integration/test_expense_manager.db \
                  python:3.12-slim \
                  sh -lc "pip install -r requirements.txt && \
                          pytest tests/api -v \
                          --alluredir=/app/allure-results \
                          --junitxml=/app/test-results/api-results.xml" || true
                '''
            }
        }

        stage('E2E Tests') {
            steps {
                sh '''
                mkdir -p allure-results test-results

                docker run --rm \
                  --network host \
                  -v ${WORKSPACE_HOST}:/app \
                  -w /app/employee \
                  -e APP_URL=http://localhost:${APP_PORT} \
                  -e DATABASE_PATH=/app/employee/tests/integration/test_expense_manager.db \
                  python:3.12-slim \
                  sh -lc "pip install -r requirements.txt && \
                          pytest tests/e2e/test_e2e_integration_20241229.py -v \
                          --alluredir=/app/allure-results \
                          --junitxml=/app/test-results/e2e-results.xml" || true

                docker run --rm \
                  --network host \
                  -v ${WORKSPACE_HOST}:/app \
                  -w /app/employee \
                  -e APP_URL=http://localhost:${APP_PORT} \
                  python:3.12-slim \
                  sh -lc "pip install -r requirements.txt && \
                          behave tests/e2e/features \
                          -f allure_behave.formatter:AllureFormatter \
                          -o /app/allure-results" || true
                '''
            }
        }

        stage('Code Coverage') {
            steps {
                sh '''
                docker run --rm \
                  -v ${WORKSPACE_HOST}:/app \
                  -w /app/employee \
                  python:3.12-slim \
                  sh -lc "pip install -r requirements.txt && \
                          coverage run -m pytest tests/unit && \
                          coverage xml -o /app/coverage.xml && \
                          coverage html -d /app/htmlcov" || true
                '''
            }
            post {
                always {
                    publishHTML(target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'htmlcov',
                        reportFiles: 'index.html',
                        reportName: 'Python Coverage'
                    ])
                }
            }
        }

        stage('Stop Test Container') {
            steps {
                sh '''
                docker stop ${APP_NAME}-test || true
                docker rm ${APP_NAME}-test || true
                '''
            }
        }

        stage('Allure Report') {
            steps {
                echo 'üìä Generating Allure Report...'
            }
        post {
        always {
            allure([
                includeProperties: false,
                results: [[path: 'allure-results']]
            ])
        }
    }
}

    }

    post {
        always {
            archiveArtifacts artifacts: '''
              test-results/**/*.xml,
              allure-results/**/*,
              htmlcov/**/*
            ''', allowEmptyArchive: true
        }

        success {
            echo '‚úÖ Employee App Pipeline Completed Successfully'
        }

        failure {
            echo '‚ùå Pipeline Failed ‚Äì check logs above'
        }
    }
}
