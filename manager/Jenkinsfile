// Manager App (Java/Javalin) - Jenkins CI/CD Pipeline
// QA Environment with Comprehensive Testing and Allure Reports

pipeline {
    agent any

    environment {
        // Application image name
        APP_NAME = 'expense-manager'
        APP_PORT = '5001'

        // Build version
        BUILD_VERSION = "${BUILD_NUMBER}"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 45, unit: 'MINUTES')
    }

    // âœ… ADD: skip toggles so you can skip stages from Jenkins UI
    parameters {
        booleanParam(name: 'SKIP_UNIT_TESTS', defaultValue: false, description: 'Skip Unit Tests stage')
        booleanParam(name: 'SKIP_INTEGRATION_TESTS', defaultValue: false, description: 'Skip Integration Tests stage')
        booleanParam(name: 'SKIP_API_TESTS', defaultValue: false, description: 'Skip API Tests stage')
        booleanParam(name: 'SKIP_E2E_TESTS', defaultValue: false, description: 'Skip E2E Tests stage')
        booleanParam(name: 'SKIP_PERFORMANCE_TESTS', defaultValue: false, description: 'Skip Performance Tests stage')
        booleanParam(name: 'SKIP_CODE_COVERAGE', defaultValue: false, description: 'Skip Code Coverage stage')
        booleanParam(name: 'SKIP_ALLURE', defaultValue: false, description: 'Skip Allure Report stage')
        booleanParam(name: 'SKIP_DEPLOY', defaultValue: false, description: 'Skip Deploy to QA stage')
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'ðŸ“¥ Checking out source code...'
                checkout scm

                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    echo "Building commit: ${env.GIT_COMMIT_SHORT}"
                }
            }
        }

        // ============================================
        // FAIL FAST: Run tests BEFORE building image
        // ============================================

        stage('Unit Tests') {
            when { expression { !params.SKIP_UNIT_TESTS } }
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21'
                    args '-v maven-repo:/root/.m2'
                    reuseNode true
                }
            }
            steps {
                echo 'ðŸ§ª Running Java Unit Tests with Allure...'
                dir('manager') {
                    // âœ… CHANGED: unit -> unittests
                    sh 'mvn clean test -Dtest="**/unittests/**" -B'
                }
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'manager/target/surefire-reports/*.xml'
                }
            }
        }

        stage('Integration Tests') {
            when { expression { !params.SKIP_INTEGRATION_TESTS } }
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21'
                    args '-v maven-repo:/root/.m2'
                    reuseNode true
                }
            }
            steps {
                echo 'ðŸ”— Running Java Integration Tests with Real Database...'
                dir('manager') {
                    // âœ… CHANGED: integration -> integrationtests
                    sh 'mvn test -Dtest="**/integrationtests/**" -B'
                }
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'manager/target/surefire-reports/*Integration*.xml'
                }
            }
        }

        // ============================================
        // BUILD: Only after tests pass
        // ============================================

        stage('Build Docker Image') {
            steps {
                echo 'â˜• Building Java Manager Application...'
                dir('manager') {
                    sh '''
                        docker build \
                            -t ${APP_NAME}:${BUILD_VERSION} \
                            -t ${APP_NAME}:latest \
                            -f Dockerfile .
                    '''
                }
            }
        }

        stage('Start Application') {
            steps {
                echo 'ðŸš€ Starting Manager App for API/E2E Testing...'
                // âœ… CHANGED: use bash + real retry loop + better diagnostics
                sh '''#!/usr/bin/env bash
                    set -euo pipefail

                    # Stop any existing container
                    docker stop ${APP_NAME}-test || true
                    docker rm ${APP_NAME}-test || true

                    # Start the container
                    docker run -d \
                        --name ${APP_NAME}-test \
                        -p ${APP_PORT}:${APP_PORT} \
                        -v expense-data:/data \
                        ${APP_NAME}:${BUILD_VERSION}

                    echo "Waiting for application to start..."
                    docker ps -a --filter "name=${APP_NAME}-test"

                    # Wait up to 90 seconds (30 attempts x 3s)
                    for i in $(seq 1 30); do
                        # If it exited, print logs and fail immediately
                        if [ "$(docker inspect -f '{{.State.Running}}' ${APP_NAME}-test)" != "true" ]; then
                            echo "âŒ Container is not running. Logs:"
                            docker logs --tail 200 ${APP_NAME}-test || true
                            exit 1
                        fi

                        if curl -fsS "http://localhost:${APP_PORT}/health" >/dev/null; then
                            echo "âœ… Application is ready!"
                            exit 0
                        fi

                        echo "â³ Not ready yet... (${i}/30)"
                        sleep 3
                    done

                    echo "âŒ Health check failed after retries. Container logs:"
                    docker logs --tail 200 ${APP_NAME}-test || true
                    exit 1
                '''
            }
        }

        stage('API Tests') {
            when { expression { !params.SKIP_API_TESTS } }
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21'
                    args '-v maven-repo:/root/.m2 --network host'
                    reuseNode true
                }
            }
            steps {
                echo 'ðŸ”Œ Running Java API Tests (REST Assured + Integration)...'
                dir('manager') {
                    sh '''
                        mvn test \
                            -Dtest="**/api/**" \
                            -Dmaven.test.failure.ignore=true \
                            -B
                    '''
                }
            }
        }

        stage('E2E Tests') {
            when { expression { !params.SKIP_E2E_TESTS } }
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21'
                    args '-v maven-repo:/root/.m2 --network host'
                    reuseNode true
                }
            }
            steps {
                echo 'ðŸŒ Running Java E2E Tests (Cucumber + Integration)...'
                dir('manager') {
                    sh '''
                        mvn test \
                            -Dtest="**/e2e/**" \
                            -Dmaven.test.failure.ignore=true \
                            -B
                    '''
                }
            }
        }

        stage('Performance Tests') {
            when { expression { !params.SKIP_PERFORMANCE_TESTS } }
            steps {
                echo 'âš¡ Running JMeter Performance Tests...'
                script {
                    if (fileExists('manager/tests/performance')) {
                        dir('manager') {
                            sh '''
                                mkdir -p jmeter-results
                                docker run --rm \
                                    --network host \
                                    -v $(pwd):/workspace \
                                    -w /workspace \
                                    justb4/jmeter:latest \
                                    -n \
                                    -t /workspace/tests/performance/*.jmx \
                                    -l /workspace/jmeter-results/results.jtl \
                                    -e \
                                    -o /workspace/jmeter-results/report || true
                            '''
                        }
                    } else {
                        echo "No JMeter test files found, skipping..."
                    }
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'manager/jmeter-results/**/*', allowEmptyArchive: true
                }
            }
        }

        stage('Code Coverage') {
            when { expression { !params.SKIP_CODE_COVERAGE } }
            agent {
                docker {
                    image 'maven:3.9-eclipse-temurin-21'
                    args '-v maven-repo:/root/.m2'
                    reuseNode true
                }
            }
            steps {
                echo 'ðŸ“ˆ Generating JaCoCo Coverage Report...'
                dir('manager') {
                    sh 'mvn jacoco:report -B || true'
                }
            }
            post {
                always {
                    publishHTML(target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'manager/target/site/jacoco',
                        reportFiles: 'index.html',
                        reportName: 'Java Coverage Report'
                    ])
                }
            }
        }

        stage('Stop Test Container') {
            steps {
                echo 'ðŸ›‘ Stopping test container...'
                sh '''
                    docker stop ${APP_NAME}-test || true
                    docker rm ${APP_NAME}-test || true
                '''
            }
        }

        stage('Generate Allure Report') {
            when { expression { !params.SKIP_ALLURE } }
            steps {
                echo 'ðŸ“Š Generating Allure Report...'
            }
            post {
                always {
                    allure([
                        includeProperties: false,
                        results: [[path: 'manager/target/allure-results']]
                    ])
                }
            }
        }

        stage('Deploy to QA') {
            when {
                allOf {
                    expression { !params.SKIP_DEPLOY }
                    branch 'main'
                    expression { currentBuild.currentResult == 'SUCCESS' }
                }
            }
            steps {
                echo 'ðŸš€ All tests passed! Deploying Manager App to QA...'

                withCredentials([sshUserPrivateKey(
                    credentialsId: 'ec2-ssh-key',
                    keyFileVariable: 'SSH_KEY'
                )]) {
                    sh '''
                        # Save and transfer Docker image
                        docker save ${APP_NAME}:${BUILD_VERSION} | gzip > ${APP_NAME}.tar.gz
                        scp -i ${SSH_KEY} -o StrictHostKeyChecking=no \
                            ${APP_NAME}.tar.gz ${EC2_USER}@${EC2_HOST}:/home/${EC2_USER}/

                        # Deploy on EC2
                        ssh -i ${SSH_KEY} -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'EOF'
                            echo "ðŸ”¨ Loading Docker image..."
                            gunzip -c ${APP_NAME}.tar.gz | docker load
                            rm ${APP_NAME}.tar.gz

                            echo "ðŸ›‘ Stopping existing container..."
                            docker stop expense-manager || true
                            docker rm expense-manager || true

                            echo "ðŸš€ Starting new container..."
                            docker run -d \
                                --name expense-manager \
                                --restart unless-stopped \
                                -p 5001:5001 \
                                -v expense-data:/data \
                                expense-manager:latest

                            sleep 30
                            curl -f http://localhost:5001/health && echo "âœ… Manager app deployed!"
EOF

                        rm ${APP_NAME}.tar.gz
                    '''
                }
            }
        }
    }

    post {
        always {
            echo 'ðŸ§¹ Cleaning up...'
            sh '''
                docker stop ${APP_NAME}-test || true
                docker rm ${APP_NAME}-test || true
                docker rmi ${APP_NAME}:${BUILD_VERSION} || true
            '''

            archiveArtifacts artifacts: '''
                manager/target/surefire-reports/**/*.xml,
                manager/target/allure-results/**/*,
                manager/target/site/jacoco/**/*
            ''', allowEmptyArchive: true
        }

        success {
            echo '''
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘  âœ… MANAGER APP PIPELINE COMPLETED SUCCESSFULLY              â•‘
            â•‘                                                              â•‘
            â•‘  ðŸ“Š Reports: Click "Allure Report" in sidebar                â•‘
            â•‘  ðŸ“ˆ Coverage: Click "Java Coverage Report"                   â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            '''
        }

        failure {
            echo 'âŒ Pipeline failed! Check console output for details.'
        }
    }
}
